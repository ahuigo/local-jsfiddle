<body oninput="autorun.checked && run()">
    <style>
        textarea,iframe{width:49%;height:47%}
        body{margin:0}
        textarea{width:49%;font-size:18}
    </style>
    <textarea placeholder=HTML id=h></textarea>
    <textarea placeholder=CSS id=c></textarea>
    <div>
        <select id="cdn"> </select>
        <input type="checkbox" id="autorun" checked> AutoRun
        <button onclick="run()">Run</button>
        <button onclick="open_page('page')">Open Page</button>
        <button onclick="copy_html('page')">Copy Page</button>
        <button onclick="copy_html('editor')">Copy Editor</button>
        <span style="color:red" id=msg></span>
        F5: Run, Ctrl+U: Delete Head; Ctrl+W: Delete Word
        MacOSX Tips: Ctrl+A:Head, Ctrl+E:End, Ctrl+F:Right, Ctrl+B:Left, Ctrl+N:Next Line, Ctrl+P: Previous Line
    </div>
    <textarea placeholder=JS id=j></textarea>
<iframe id=i></iframe>
<script>
let cdnjs = {
    'dexie': 'https://unpkg.com/dexie@latest/dist/dexie.js',
    'vue': 'https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js',
    'jquery': 'https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js',
};
cdn.innerHTML=`<option>loadjs</option>`;
for(let k in cdnjs){
    cdn.innerHTML+=`<option>${k}</option>`;
}
cdn.onchange = function(){
    let src = cdnjs[this.value];
    if(src){
        h.value = `<script src="${src}"></`+`script>\n`+ h.value;
    }
};
document.addEventListener('keydown', e=>{
    if(e.key==='F5'){
        run();
    }
    if(e.target.tagName === 'TEXTAREA'){
        var target = e.target;   
        if (e.keyCode === 9) {
            var start = target.selectionStart;   
            var end = target.selectionEnd;
            target.value=target.value.slice(0, start) + "\t" + target.value.slice(end);
            target.selectionStart = target.selectionEnd = start + 1;
            e.preventDefault();
        } else if(e.ctrlKey && e.keyCode===85) {
            var start = target.selectionStart;   
            var end = target.selectionEnd;
            var start = target.value.slice(0, start).lastIndexOf('\n')+1;
            target.value=target.value.slice(0, start) + target.value.slice(end);
            target.selectionStart = target.selectionEnd = start;
            e.preventDefault();
        }else if(e.ctrlKey && e.code==='KeyW') {
            var start = target.selectionStart;   
            var end = target.selectionEnd;
            let m = target.value.slice(0, start).match(/(\s*\S+\s*|\s+|.)$/);
            if(m){
                target.value=target.value.slice(0, m.index) + target.value.slice(end);
                target.selectionStart = target.selectionEnd = m.index;
            }
            e.preventDefault();
        }
    }
});
function run(){ i.srcdoc=h.value+'<style>'+c.value+'</style><script>'+j.value+'<\/script>';
}
function open_page(type){
    let h = `${i.srcdoc}`;
    console.log(h);
    let page = window.open();
    page.document.write(h);
}
function copy_html(type){
    if(type === 'page'){
        text = `${i.srcdoc}`;
    } else if(type=== 'editor'){
        let srcdoc = i.srcdoc;
        i.srcdoc = '';
        for(let node of [h,c,j]){
            node.innerText = node.value;
        }
        text = `data:text/html,${document.documentElement.innerHTML}`;
        i.srcdoc = srcdoc;
    }
    if(copy(text)){
        msg.innerText = `copy ${type} success!`;
        setTimeout(v=>msg.innerText='',2000);
    }
}
function copy(text) {
    var node = document.createElement('textarea');
    node.innerHTML = text;
    document.body.appendChild(node);
    node.select();
    var result = document.execCommand('copy');
    document.body.removeChild(node);
    return result;
}
run();
</script>
